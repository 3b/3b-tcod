(in-package #:3b-tcod)

(eval-when (:compile-toplevel :load-toplevel :execute)
  (declaim (inline decompose-color compose-color))
  (defun compose-color (r g b &optional (a 0))
    (logior (ash (ldb (byte 8 0) r) 0)
            (ash (ldb (byte 8 0) g) 8)
            (ash (ldb (byte 8 0) b) 16)
            (ash (ldb (byte 8 0) a) 24)))

  (defun decompose-color (c)
    (values (ldb (byte 8 0) c)
            (ldb (byte 8 8) c)
            (ldb (byte 8 16) c)
            (ldb (byte 8 24) c))))

(defun tcod-color (name)
  (ecase name
    ;; from tcod
    (:amber #.(compose-color 255 191 0))
    (:azure #.(compose-color 0 127 255))
    (:black #.(compose-color 0 0 0))
    (:blue #.(compose-color 0 0 255))
    (:brass #.(compose-color 191 151 96))
    (:celadon #.(compose-color 172 255 175))
    (:chartreuse #.(compose-color 127 255 0))
    (:copper #.(compose-color 197 136 124))
    (:crimson #.(compose-color 255 0 63))
    (:cyan #.(compose-color 0 255 255))
    (:dark-amber #.(compose-color 191 143 0))
    (:dark-azure #.(compose-color 0 95 191))
    (:dark-blue #.(compose-color 0 0 191))
    (:dark-chartreuse #.(compose-color 95 191 0))
    (:dark-crimson #.(compose-color 191 0 47))
    (:dark-cyan #.(compose-color 0 191 191))
    (:dark-flame #.(compose-color 191 47 0))
    (:dark-fuchsia #.(compose-color 191 0 191))
    (:dark-gray #.(compose-color 95 95 95))
    (:dark-green #.(compose-color 0 191 0))
    (:dark-grey #.(compose-color 95 95 95))
    (:dark-han #.(compose-color 47 0 191))
    (:dark-lime #.(compose-color 143 191 0))
    (:dark-magenta #.(compose-color 191 0 143))
    (:dark-orange #.(compose-color 191 95 0))
    (:dark-pink #.(compose-color 191 0 95))
    (:dark-purple #.(compose-color 143 0 191))
    (:dark-red #.(compose-color 191 0 0))
    (:dark-sea #.(compose-color 0 191 95))
    (:dark-sepia #.(compose-color 94 75 47))
    (:dark-sky #.(compose-color 0 143 191))
    (:dark-turquoise #.(compose-color 0 191 143))
    (:dark-violet #.(compose-color 95 0 191))
    (:dark-yellow #.(compose-color 191 191 0))
    (:darker-amber #.(compose-color 127 95 0))
    (:darker-azure #.(compose-color 0 63 127))
    (:darker-blue #.(compose-color 0 0 127))
    (:darker-chartreuse #.(compose-color 63 127 0))
    (:darker-crimson #.(compose-color 127 0 31))
    (:darker-cyan #.(compose-color 0 127 127))
    (:darker-flame #.(compose-color 127 31 0))
    (:darker-fuchsia #.(compose-color 127 0 127))
    (:darker-gray #.(compose-color 63 63 63))
    (:darker-green #.(compose-color 0 127 0))
    (:darker-grey #.(compose-color 63 63 63))
    (:darker-han #.(compose-color 31 0 127))
    (:darker-lime #.(compose-color 95 127 0))
    (:darker-magenta #.(compose-color 127 0 95))
    (:darker-orange #.(compose-color 127 63 0))
    (:darker-pink #.(compose-color 127 0 63))
    (:darker-purple #.(compose-color 95 0 127))
    (:darker-red #.(compose-color 127 0 0))
    (:darker-sea #.(compose-color 0 127 63))
    (:darker-sepia #.(compose-color 63 50 31))
    (:darker-sky #.(compose-color 0 95 127))
    (:darker-turquoise #.(compose-color 0 127 95))
    (:darker-violet #.(compose-color 63 0 127))
    (:darker-yellow #.(compose-color 127 127 0))
    (:darkest-amber #.(compose-color 63 47 0))
    (:darkest-azure #.(compose-color 0 31 63))
    (:darkest-blue #.(compose-color 0 0 63))
    (:darkest-chartreuse #.(compose-color 31 63 0))
    (:darkest-crimson #.(compose-color 63 0 15))
    (:darkest-cyan #.(compose-color 0 63 63))
    (:darkest-flame #.(compose-color 63 15 0))
    (:darkest-fuchsia #.(compose-color 63 0 63))
    (:darkest-gray #.(compose-color 31 31 31))
    (:darkest-green #.(compose-color 0 63 0))
    (:darkest-grey #.(compose-color 31 31 31))
    (:darkest-han #.(compose-color 15 0 63))
    (:darkest-lime #.(compose-color 47 63 0))
    (:darkest-magenta #.(compose-color 63 0 47))
    (:darkest-orange #.(compose-color 63 31 0))
    (:darkest-pink #.(compose-color 63 0 31))
    (:darkest-purple #.(compose-color 47 0 63))
    (:darkest-red #.(compose-color 63 0 0))
    (:darkest-sea #.(compose-color 0 63 31))
    (:darkest-sepia #.(compose-color 31 24 15))
    (:darkest-sky #.(compose-color 0 47 63))
    (:darkest-turquoise #.(compose-color 0 63 47))
    (:darkest-violet #.(compose-color 31 0 63))
    (:darkest-yellow #.(compose-color 63 63 0))
    (:desaturated-amber #.(compose-color 127 111 63))
    (:desaturated-azure #.(compose-color 63 95 127))
    (:desaturated-blue #.(compose-color 63 63 127))
    (:desaturated-chartreuse #.(compose-color 95 127 63))
    (:desaturated-crimson #.(compose-color 127 63 79))
    (:desaturated-cyan #.(compose-color 63 127 127))
    (:desaturated-flame #.(compose-color 127 79 63))
    (:desaturated-fuchsia #.(compose-color 127 63 127))
    (:desaturated-green #.(compose-color 63 127 63))
    (:desaturated-han #.(compose-color 79 63 127))
    (:desaturated-lime #.(compose-color 111 127 63))
    (:desaturated-magenta #.(compose-color 127 63 111))
    (:desaturated-orange #.(compose-color 127 95 63))
    (:desaturated-pink #.(compose-color 127 63 95))
    (:desaturated-purple #.(compose-color 111 63 127))
    (:desaturated-red #.(compose-color 127 63 63))
    (:desaturated-sea #.(compose-color 63 127 95))
    (:desaturated-sky #.(compose-color 63 111 127))
    (:desaturated-turquoise #.(compose-color 63 127 111))
    (:desaturated-violet #.(compose-color 95 63 127))
    (:desaturated-yellow #.(compose-color 127 127 63))
    (:flame #.(compose-color 255 63 0))
    (:fuchsia #.(compose-color 255 0 255))
    (:gold #.(compose-color 229 191 0))
    (:gray #.(compose-color 127 127 127))
    (:green #.(compose-color 0 255 0))
    (:grey #.(compose-color 127 127 127))
    (:han #.(compose-color 63 0 255))
    (:light-amber #.(compose-color 255 219 114))
    (:light-azure #.(compose-color 114 184 255))
    (:light-blue #.(compose-color 114 114 255))
    (:light-chartreuse #.(compose-color 184 255 114))
    (:light-crimson #.(compose-color 255 114 149))
    (:light-cyan #.(compose-color 114 255 255))
    (:light-flame #.(compose-color 255 149 114))
    (:light-fuchsia #.(compose-color 255 114 255))
    (:light-gray #.(compose-color 159 159 159))
    (:light-green #.(compose-color 114 255 114))
    (:light-grey #.(compose-color 159 159 159))
    (:light-han #.(compose-color 149 114 255))
    (:light-lime #.(compose-color 219 255 114))
    (:light-magenta #.(compose-color 255 114 219))
    (:light-orange #.(compose-color 255 184 114))
    (:light-pink #.(compose-color 255 114 184))
    (:light-purple #.(compose-color 219 114 255))
    (:light-red #.(compose-color 255 114 114))
    (:light-sea #.(compose-color 114 255 184))
    (:light-sepia #.(compose-color 158 134 100))
    (:light-sky #.(compose-color 114 219 255))
    (:light-turquoise #.(compose-color 114 255 219))
    (:light-violet #.(compose-color 184 114 255))
    (:light-yellow #.(compose-color 255 255 114))
    (:lighter-amber #.(compose-color 255 232 165))
    (:lighter-azure #.(compose-color 165 210 255))
    (:lighter-blue #.(compose-color 165 165 255))
    (:lighter-chartreuse #.(compose-color 210 255 165))
    (:lighter-crimson #.(compose-color 255 165 188))
    (:lighter-cyan #.(compose-color 165 255 255))
    (:lighter-flame #.(compose-color 255 188 165))
    (:lighter-fuchsia #.(compose-color 255 165 255))
    (:lighter-gray #.(compose-color 191 191 191))
    (:lighter-green #.(compose-color 165 255 165))
    (:lighter-grey #.(compose-color 191 191 191))
    (:lighter-han #.(compose-color 188 165 255))
    (:lighter-lime #.(compose-color 232 255 165))
    (:lighter-magenta #.(compose-color 255 165 232))
    (:lighter-orange #.(compose-color 255 210 165))
    (:lighter-pink #.(compose-color 255 165 210))
    (:lighter-purple #.(compose-color 232 165 255))
    (:lighter-red #.(compose-color 255 165 165))
    (:lighter-sea #.(compose-color 165 255 210))
    (:lighter-sepia #.(compose-color 191 171 143))
    (:lighter-sky #.(compose-color 165 232 255))
    (:lighter-turquoise #.(compose-color 165 255 232))
    (:lighter-violet #.(compose-color 210 165 255))
    (:lighter-yellow #.(compose-color 255 255 165))
    (:lightest-amber #.(compose-color 255 239 191))
    (:lightest-azure #.(compose-color 191 223 255))
    (:lightest-blue #.(compose-color 191 191 255))
    (:lightest-chartreuse #.(compose-color 223 255 191))
    (:lightest-crimson #.(compose-color 255 191 207))
    (:lightest-cyan #.(compose-color 191 255 255))
    (:lightest-flame #.(compose-color 255 207 191))
    (:lightest-fuchsia #.(compose-color 255 191 255))
    (:lightest-gray #.(compose-color 223 223 223))
    (:lightest-green #.(compose-color 191 255 191))
    (:lightest-grey #.(compose-color 223 223 223))
    (:lightest-han #.(compose-color 207 191 255))
    (:lightest-lime #.(compose-color 239 255 191))
    (:lightest-magenta #.(compose-color 255 191 239))
    (:lightest-orange #.(compose-color 255 223 191))
    (:lightest-pink #.(compose-color 255 191 223))
    (:lightest-purple #.(compose-color 239 191 255))
    (:lightest-red #.(compose-color 255 191 191))
    (:lightest-sea #.(compose-color 191 255 223))
    (:lightest-sepia #.(compose-color 222 211 195))
    (:lightest-sky #.(compose-color 191 239 255))
    (:lightest-turquoise #.(compose-color 191 255 239))
    (:lightest-violet #.(compose-color 223 191 255))
    (:lightest-yellow #.(compose-color 255 255 191))
    (:lime #.(compose-color 191 255 0))
    (:magenta #.(compose-color 255 0 191))
    (:orange #.(compose-color 255 127 0))
    (:peach #.(compose-color 255 159 127))
    (:pink #.(compose-color 255 0 127))
    (:purple #.(compose-color 191 0 255))
    (:red #.(compose-color 255 0 0))
    (:sea #.(compose-color 0 255 127))
    (:sepia #.(compose-color 127 101 63))
    (:silver #.(compose-color 203 203 203))
    (:sky #.(compose-color 0 191 255))
    (:turquoise #.(compose-color 0 255 191))
    (:violet #.(compose-color 127 0 255))
    (:white #.(compose-color 255 255 255))
    (:yellow #.(compose-color 255 255 0))))

(defun css-color (name)
  (ecase name
    ;; from css colors
    ;; #xbbggrr, so backwards from css/html/etc
    (:alice-blue #xfff8f0)
    (:antique-white #xd7ebfa)
    (:aqua #xffff00)
    (:aquamarine #xd4ff7f)
    (:azure #xfffff0)
    (:beige #xdcf5f5)
    (:bisque #xc4e4ff)
    (:black #x000000)
    (:blanched-almond #xcdebff)
    (:blue #xff0000)
    (:blue-violet #xe22b8a)
    (:brown #x2a2aa5)
    (:burly-wood #x87b8de)
    (:cadet-blue #xa09e5f)
    (:chartreuse #x00ff7f)
    (:chocolate #x1e69d2)
    (:coral #x507fff)
    (:cornflower-blue #xed9564)
    (:cornsilk #xdcf8ff)
    (:crimson #x3c14dc)
    (:cyan #xffff00)
    (:dark-blue #x8b0000)
    (:dark-cyan #x8b8b00)
    (:dark-goldenrod #x0b86b8)
    (:dark-gray #xa9a9a9)
    (:dark-green #x006400)
    (:dark-grey #xa9a9a9)
    (:dark-khaki #x6bb7bd)
    (:dark-magenta #x8b008b)
    (:dark-olive-green #x2f6b55)
    (:dark-orange #x008cff)
    (:dark-orchid #xcc3299)
    (:dark-red #x00008b)
    (:dark-salmon #x7a96e9)
    (:dark-seagreen #x8fbc8f)
    (:dark-slate-blue #x8b3d48)
    (:dark-slate-gray #x4f4f2f)
    (:dark-slate-grey #x4f4f2f)
    (:dark-turquoise #xd1ce00)
    (:dark-violet #xd30094)
    (:deep-pink #x9314ff)
    (:deep-sky-blue #xffbf00)
    (:dim-gray #x696969)
    (:dim-grey #x696969)
    (:dodger-blue #xff901e)
    (:firebrick #x2222b2)
    (:floral-white #xf0faff)
    (:forest-green #x228b22)
    (:fuchsia #xff00ff)
    (:gainsboro #xdcdcdc)
    (:ghost-white #xfff8f8)
    (:gold #x00d7ff)
    (:goldenrod #x20a5da)
    (:gray #x808080)
    (:green #x008000)
    (:green-yellow #x2fffad)
    (:grey #x808080)
    (:honeydew #xf0fff0)
    (:hot-pink #xb469ff)
    (:indian-red #x5c5ccd)
    (:indigo #x82004b)
    (:ivory #xf0ffff)
    (:khaki #x8ce6f0)
    (:lavender #xfae6e6)
    (:lavender-blush #xf5f0ff)
    (:lawn-green #x00fc7c)
    (:lemon-chiffon #xcdfaff)
    (:light-blue #xe6d8ad)
    (:light-coral #x8080f0)
    (:light-cyan #xffffe0)
    (:light-goldenrod-yellow #xd2fafa)
    (:light-gray #xd3d3d3)
    (:light-green #x90ee90)
    (:light-grey #xd3d3d3)
    (:light-pink #xc1b6ff)
    (:light-salmon #x7aa0ff)
    (:light-seagreen #xaab220)
    (:light-skyblue #xface87)
    (:light-slategray #x998877)
    (:light-slategrey #x998877)
    (:light-steelblue #xdec4b0)
    (:light-yellow #xe0ffff)
    (:lime #x00ff00)
    (:lime-green #x32cd32)
    (:linen #xe6f0fa)
    (:magenta #xff00ff)
    (:maroon #x000080)
    (:medium-aquamarine #xaacd66)
    (:medium-blue #xcd0000)
    (:medium-orchid #xd355ba)
    (:medium-purple #xdb7093)
    (:medium-sea-green #x71b33c)
    (:medium-slate-blue #xee687b)
    (:medium-spring-green #x9afa00)
    (:medium-turquoise #xccd148)
    (:medium-violet-red #x8515c7)
    (:midnight-blue #x701919)
    (:mint-cream #xfafff5)
    (:misty-rose #xe1e4ff)
    (:moccasin #xb5e4ff)
    (:navajo-white #xaddeff)
    (:navy #x800000)
    (:old-lace #xe6f5fd)
    (:olive #x008080)
    (:olive-drab #x238e6b)
    (:orange #x00a5ff)
    (:orange-red #x0045ff)
    (:orchid #xd670da)
    (:pale-goldenrod #xaae8ee)
    (:pale-green #x98fb98)
    (:pale-turquoise #xeeeeaf)
    (:pale-violet-red #x9370db)
    (:papaya-whip #xd5efff)
    (:peach-puff #xb9daff)
    (:peru #x3f85cd)
    (:pink #xcbc0ff)
    (:plum #xdda0dd)
    (:powder-blue #xe6e0b0)
    (:purple #x800080)
    (:rebecca-purple #x993366)
    (:red #x0000ff)
    (:rosy-brown #x8f8fbc)
    (:royal-blue #xe16941)
    (:saddle-brown #x13458b)
    (:salmon #x7280fa)
    (:sandy-brown #x60a4f4)
    (:sea-green #x578b2e)
    (:seashell #xeef5ff)
    (:sienna #x2d52a0)
    (:silver #xc0c0c0)
    (:skyblue #xebce87)
    (:slate-blue #xcd5a6a)
    (:slate-gray #x908070)
    (:slate-grey #x908070)
    (:snow #xfafaff)
    (:spring-green #x7fff00)
    (:steel-blue #xb48246)
    (:tan #x8cb4d2)
    (:teal #x808000)
    (:thistle #xd8bfd8)
    (:tomato #x4763ff)
    (:turquoise #xd0e040)
    (:violet #xee82ee)
    (:wheat #xb3def5)
    (:white #xffffff)
    (:white-smoke #xf5f5f5)
    (:yellow #x00ffff)
    (:yellow-green #x32cd9a)))

(defun color (c)
  ;; current sbcl takes 70sec to compile this file without this :/
  (declare (notinline tcod-color css-color))
  (if (typep c '(unsigned-byte 32))
      c
      ;; fixme: make a merged function so error can list options?
      ;; (might not be worth it since list would be huge and/or
      ;; truncated anyway)
      (or (ignore-errors (tcod-color c))
          (ignore-errors (css-color c))
          (error "unrecognized color name ~s" c))))

(define-compiler-macro color (&whole w c)
  (if (and (constantp c) (ignore-errors (color c)))
      (color c)
      w))
